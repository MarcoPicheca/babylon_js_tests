<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Pong Online Tester</title>
        <!-- Style remains same -->
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #1a1a1a;
            color: #fff;
            display: flex;
            height: 100vh;
        }
        
        #sidebar {
            width: 350px;
            background-color: #2a2a2a;
            padding: 20px;
            overflow-y: auto;
            border-right: 2px solid #00ff00;
        }
        
        #game-container {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        #game-info {
            background-color: #2a2a2a;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #00ff00;
        }
        
        #renderCanvas {
            flex: 1;
            width: 100%;
            height: 100%;
            display: block;
            outline: none;
        }
        
        h2 {
            color: #00ff00;
            margin-top: 0;
            border-bottom: 2px solid #00ff00;
            padding-bottom: 10px;
        }
        
        .section {
            background-color: #333;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
            border: 1px solid #444;
        }
        
        .section h3 {
            margin: 0 0 10px 0;
            color: #00ff00;
            font-size: 16px;
        }
        
        input {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            background-color: #222;
            border: 1px solid #555;
            border-radius: 4px;
            color: #fff;
            box-sizing: border-box;
        }
        
        button {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        
        button:hover:not(:disabled) {
            background-color: #0056b3;
        }
        
        button:disabled {
            background-color: #555;
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        button.danger {
            background-color: #dc3545;
        }
        
        button.danger:hover:not(:disabled) {
            background-color: #c82333;
        }
        
        button.success {
            background-color: #28a745;
        }
        
        button.success:hover:not(:disabled) {
            background-color: #218838;
        }
        
        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 3px;
            font-weight: bold;
            font-size: 14px;
        }
        
        .status.connected {
            background-color: #28a745;
        }
        
        .status.disconnected {
            background-color: #dc3545;
        }
        
        .status.in-game {
            background-color: #17a2b8;
        }
        
        .status.matchmaking {
            background-color: #ffc107;
            color: #000;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 5px 0;
        }
        
        .info-label {
            color: #aaa;
            font-size: 14px;
        }
        
        .info-value {
            color: #00ff00;
            font-weight: bold;
        }
        
        #log {
            background-color: #000;
            color: #00ff00;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            border: 1px solid #00ff00;
            border-radius: 4px;
            margin-top: 10px;
        }
        
        .score-display {
            font-size: 24px;
            text-align: center;
            padding: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div id="sidebar">
        <h2>üèì Pong Online Tester</h2>
        
        <div class="section">
            <h3>üîê Authentication</h3>
            <input type="email" id="emailInput" placeholder="Email" value="test1@gmail.com">
            <input type="password" id="passwordInput" placeholder="Password" value="1234">
            <button id="loginBtn" class="success">Login & Connect</button>
            <button id="logoutBtn" class="danger" style="display: none;">Logout</button>
        </div>
        
        <div class="section">
            <h3>üìä Status</h3>
            <div class="info-row">
                <span class="info-label">Game Mode:</span>
                <select id="gameModeSelect" style="background-color: #222; color: #fff; border: 1px solid #555; padding: 5px; border-radius: 4px;">
                    <option value="online">Online Multiplayer</option>
                    <option value="offline-multiplayer">Offline Multiplayer</option>
                    <option value="offline-ai">Offline vs AI</option>
                </select>
            </div>
            <div class="info-row">
                <span class="info-label">Connection:</span>
                <span id="statusDisplay" class="status disconnected">Disconnected</span>
            </div>
            <div class="info-row">
                <span class="info-label">User ID:</span>
                <span id="userIdDisplay" class="info-value">-</span>
            </div>
            <div class="info-row">
                <span class="info-label">Game ID:</span>
                <span id="gameIdDisplay" class="info-value">-</span>
            </div>
            <div class="info-row">
                <span class="info-label">Your Side:</span>
                <span id="sideDisplay" class="info-value">-</span>
            </div>
            <div class="info-row">
                <span class="info-label">Opponent:</span>
                <span id="opponentDisplay" class="info-value">-</span>
            </div>
        </div>
        
        <div class="section">
            <h3>üéÆ Matchmaking</h3>
            <button id="joinMatchmakingBtn" class="success" disabled>Join Matchmaking</button>
            <button id="leaveMatchmakingBtn" class="danger" disabled>Leave Matchmaking</button>
        </div>
        
        <div class="section">
            <h3>üéØ Custom Game</h3>
            <input type="text" id="opponentIdInput" placeholder="Opponent User ID" disabled>
            <button id="createCustomBtn" disabled>Create Custom Game</button>
            <input type="text" id="gameIdInput" placeholder="Game ID to Join" disabled>
            <button id="joinCustomBtn" disabled>Join Custom Game</button>
        </div>
        
        <div class="section">
            <h3>‚öôÔ∏è Game Controls</h3>
            <button id="startOfflineBtn" class="success" style="display: none;">Start Offline Game</button>
            <button id="stopOfflineBtn" class="danger" style="display: none;">Stop Offline Game</button>
            <button id="readyBtn" class="success" disabled>Ready</button>
            <button id="notReadyBtn" class="danger" disabled>Not Ready</button>
            <button id="quitBtn" class="danger" disabled>Quit Game</button>
            <div class="score-display">
                <div><span id="leftPlayerName">Player 1</span>: <span id="leftScore">0</span></div>
                <div style="margin: 5px 0;">VS</div>
                <div><span id="rightPlayerName">Player 2</span>: <span id="rightScore">0</span></div>
            </div>
        </div>
        
        <div class="section">
            <h3>üìù Log</h3>
            <button id="clearLogBtn">Clear Log</button>
            <div id="log"></div>
        </div>
    </div>
    
    <div id="game-container">
        <div id="game-info">
            <div>
                <strong>Controls:</strong> <span id="controlsText">Arrow Keys / W & S to move paddle</span>
            </div>
            <div>
                <strong>Mode:</strong> <span id="gameModeDisplay">Waiting...</span>
            </div>
        </div>
        <canvas id="renderCanvas"></canvas>
    </div>
    
    <script type="module">
        import { PongGame, GAME_MODES } from './src/main.js';
        
        // Configuration
        const GATEWAY_URL = 'https://localhost:3000';
        const WS_URL = 'wss://localhost:3000/pong/ws';
        
        // State
        let ws = null;
        let currentUserId = null;
        let currentGameId = null;
        let playerSide = null;
        let opponentUsername = null;
        let isInMatchmaking = false;
        
        // UI mapping for Game Modes
        const MODE_MAPPING = {
            'online': GAME_MODES.ONLINE,
            'offline-multiplayer': GAME_MODES.LOCAL_MULTIPLAYER,
            'offline-ai': GAME_MODES.LOCAL_VS_AI
        };

        // Initialize Game
        const game = new PongGame('renderCanvas', GAME_MODES.ONLINE, {
            playerNames: { left: 'Player 1', right: 'Player 2' }
        });

        // Logging
        function log(message, type = 'info') {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ff5555' : 
                         type === 'success' ? '#55ff55' : 
                         type === 'warn' ? '#ffff55' : '#00ff00';
            logElement.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        // Update UI
        function updateUI() {
            const connected = ws && ws.readyState === WebSocket.OPEN;
            const inGame = currentGameId !== null;
            const uiMode = document.getElementById('gameModeSelect').value;
            const isOffline = game.gameManager.mode !== GAME_MODES.ONLINE;
            
            // Status
            let statusText = 'Disconnected';
            let statusClass = 'disconnected';
            if (isOffline) {
                statusText = 'Offline Game';
                statusClass = 'in-game';
            } else if (connected) {
                if (inGame) {
                    statusText = 'In Game';
                    statusClass = 'in-game';
                } else if (isInMatchmaking) {
                    statusText = 'Matchmaking';
                    statusClass = 'matchmaking';
                } else {
                    statusText = 'Connected';
                    statusClass = 'connected';
                }
            }
            
            document.getElementById('statusDisplay').textContent = statusText;
            document.getElementById('statusDisplay').className = `status ${statusClass}`;
            document.getElementById('userIdDisplay').textContent = currentUserId || '-';
            document.getElementById('gameIdDisplay').textContent = currentGameId || '-';
            document.getElementById('sideDisplay').textContent = playerSide || '-';
            document.getElementById('opponentDisplay').textContent = opponentUsername || '-';
            
            // Game mode display
            let modeText = 'Waiting...';
            if (isOffline) {
                modeText = game.gameManager.mode === GAME_MODES.LOCAL_VS_AI ? 'Offline vs AI' : 'Offline Multiplayer';
            } else if (inGame) {
                modeText = 'Online Match';
            }
            document.getElementById('gameModeDisplay').textContent = modeText;
            
            // Controls text
            let controlsText = 'Arrow Keys / W & S to move paddle';
            if (isOffline && game.gameManager.mode === GAME_MODES.LOCAL_MULTIPLAYER) {
                controlsText = 'Player 1: W/S | Player 2: Arrow Keys';
            }
            document.getElementById('controlsText').textContent = controlsText;
            
            // Game mode selector
            document.getElementById('gameModeSelect').disabled = connected || isOffline;
            
            // Offline controls
            const showOfflineControls = uiMode !== 'online' && !connected;
            document.getElementById('startOfflineBtn').style.display = showOfflineControls && !isOffline ? 'block' : 'none';
            document.getElementById('stopOfflineBtn').style.display = isOffline ? 'block' : 'none';
            
            // Online controls
            const showOnlineControls = uiMode === 'online';
            document.getElementById('emailInput').disabled = connected || !showOnlineControls;
            document.getElementById('passwordInput').disabled = connected || !showOnlineControls;
            document.getElementById('loginBtn').style.display = connected || !showOnlineControls ? 'none' : 'block';
            document.getElementById('logoutBtn').style.display = connected && showOnlineControls ? 'block' : 'none';
            document.getElementById('joinMatchmakingBtn').disabled = !connected || inGame || isInMatchmaking || !showOnlineControls;
            document.getElementById('leaveMatchmakingBtn').disabled = !connected || !isInMatchmaking || !showOnlineControls;
            document.getElementById('opponentIdInput').disabled = !connected || inGame || !showOnlineControls;
            document.getElementById('createCustomBtn').disabled = !connected || inGame || !showOnlineControls;
            document.getElementById('gameIdInput').disabled = !connected || inGame || !showOnlineControls;
            document.getElementById('joinCustomBtn').disabled = !connected || inGame || !showOnlineControls;
            document.getElementById('readyBtn').disabled = !connected || !inGame || !showOnlineControls;
            document.getElementById('notReadyBtn').disabled = !connected || !inGame || !showOnlineControls;
            document.getElementById('quitBtn').disabled = !connected || !inGame || !showOnlineControls;
        }
        
        // Game actions
        function startOfflineGame() {
            const uiMode = document.getElementById('gameModeSelect').value;
            const mode = MODE_MAPPING[uiMode];
            
            let names = { left: 'Player 1', right: 'Player 2' };
            if (mode === GAME_MODES.LOCAL_VS_AI) {
                names = { left: 'You', right: 'AI' };
            }

            game.changeMode(mode, { playerNames: names });
            
            document.getElementById('leftPlayerName').textContent = names.left;
            document.getElementById('rightPlayerName').textContent = names.right;
            
            log(`Started ${uiMode} game`, 'success');
            updateUI();
        }
        
        function stopOfflineGame() {
            game.changeMode(GAME_MODES.ONLINE);
            document.getElementById('gameModeSelect').value = 'online';
            
            document.getElementById('leftPlayerName').textContent = 'Player 1';
            document.getElementById('rightPlayerName').textContent = 'Player 2';
            
            log('Stopped offline game', 'info');
            updateUI();
        }

        // Login
        async function login() {
            const email = document.getElementById('emailInput').value.trim();
            const password = document.getElementById('passwordInput').value.trim();
            
            if (!email || !password) {
                log('Please enter email and password', 'error');
                return;
            }
            
            try {
                log('Logging in...', 'info');
                
                const response = await fetch(`${GATEWAY_URL}/auth/login`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || errorData.message || response.statusText || 'Login failed');
                }
                
                const data = await response.json();
                currentUserId = data.user.id;
                
                log(`‚úì Logged in as ${currentUserId}`, 'success');
                connectWs();
            } catch (err) {
                if (err.message === 'Failed to fetch') {
                    const msg = `Login failed: Network error.\n\nSince the backend uses self-signed certificates, functionality is blocked until you trust them.\n\nPlease open ${GATEWAY_URL} in a new tab, acccept the security warning, and then try again here.`;
                    log(msg, 'error');
                } else {
                    log(`Login failed: ${err.message}`, 'error');
                }
            }
        }
        
        // WebSocket
        function connectWs() {
            if (ws) return;
            
            try {
                log('Connecting to WebSocket...', 'info');
                ws = new WebSocket(WS_URL);
                
                ws.onopen = function() {
                    log('‚úì WebSocket connected', 'success');
                    updateUI();
                    sendMessage('ping', {});
                };
                
                ws.onmessage = function(event) {
                    try {
                        const message = JSON.parse(event.data);
                        handleMessage(message);
                    } catch (e) {
                        log('Error parsing message: ' + e.message, 'error');
                    }
                };
                
                ws.onclose = function(event) {
                    log(`Connection closed (code: ${event.code})`, 'error');
                    ws = null;
                    currentGameId = null;
                    playerSide = null;
                    opponentUsername = null;
                    isInMatchmaking = false;
                    updateUI();
                };
                
                ws.onerror = function() {
                    log('WebSocket error', 'error');
                };
            } catch (e) {
                log('Failed to connect: ' + e.message, 'error');
            }
        }
        
        function logout() {
            if (ws) ws.close();
            ws = null;
            currentUserId = null;
            currentGameId = null;
            playerSide = null;
            opponentUsername = null;
            isInMatchmaking = false;
            log('Logged out', 'info');
            updateUI();
        }
        
        function sendMessage(event, data) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ event, data }));
                if (event !== 'pong.paddleMove') {
                    log(`‚Üí ${event}`, 'info');
                }
            } else {
                log('Cannot send: not connected', 'error');
            }
        }
        
        // Handle messages
        function handleMessage(message) {
            switch (message.event) {
                case 'pong.matchedInRandomGame':
                    currentGameId = message.data.gameId;
                    playerSide = message.data.yourSide;
                    opponentUsername = message.data.opponentUsername;
                    isInMatchmaking = false;
                    log(`Matched! You're ${playerSide} vs ${opponentUsername}`, 'success');
                    updateNamesFromOnline();
                    updateUI();
                    setTimeout(() => setReady(true), 200);
                    break;
                    
                case 'pong.gameStarted':
                    playerSide = message.data.yourSide;
                    opponentUsername = message.data.opponentUsername;
                    log(`Game starting! You're ${playerSide}`, 'success');
                    updateNamesFromOnline();
                    updateUI();
                    break;
                    
                case 'pong.gameState':
                    game.updateOnlineState(message.data);
                    // Also update side-panel scores
                    updateScoresFromState(message.data.scores);
                    break;
                    
                case 'pong.score':
                    updateScoresFromState(message.data.scores);
                    break;
                    
                case 'pong.gameEnded':
                    handleGameEnd(message.data);
                    break;
                    
                case 'pong.customGameCreated':
                    currentGameId = message.data.gameId;
                    opponentUsername = message.data.otherUsername;
                    log(`Custom game created! Waiting for ${opponentUsername}...`, 'success');
                    updateUI();
                    break;
                    
                case 'pong.customGameJoinSuccess':
                    currentGameId = message.data.gameId;
                    opponentUsername = message.data.creatorUsername;
                    log(`Joined ${opponentUsername}'s game!`, 'success');
                    updateUI();
                    break;
                    
                case 'error':
                    log(`Error: ${message.data.message}`, 'error');
                    break;
            }
        }

        function updateNamesFromOnline() {
            const names = playerSide === 'left' 
                ? { left: 'You', right: opponentUsername || 'Opponent' }
                : { left: opponentUsername || 'Opponent', right: 'You' };
            
            game.updatePlayerNames(names.left, names.right);
            document.getElementById('leftPlayerName').textContent = names.left;
            document.getElementById('rightPlayerName').textContent = names.right;
        }

        function updateScoresFromState(scores) {
            // scores is {id: score} (keys might be strings)
            const scoreKeys = Object.keys(scores);
            if (scoreKeys.length >= 1) {
                let leftScore = 0;
                let rightScore = 0;
                
                if (playerSide === 'left') {
                    leftScore = scores[currentUserId] || 0;
                    const oppId = scoreKeys.find(id => String(id) !== String(currentUserId));
                    rightScore = oppId ? scores[oppId] : 0;
                } else if (playerSide === 'right') {
                    rightScore = scores[currentUserId] || 0;
                    const oppId = scoreKeys.find(id => String(id) !== String(currentUserId));
                    leftScore = oppId ? scores[oppId] : 0;
                }
                
                game.gameManager.setScores(leftScore, rightScore);
                
                document.getElementById('leftScore').textContent = leftScore;
                document.getElementById('rightScore').textContent = rightScore;
            }
        }
        
        function handleGameEnd(data) {
            const isWinner = data.winner === currentUserId;
            const resultText = isWinner ? 'üéâ YOU WON!' : 'üò¢ You Lost';
            log(`${resultText}`, isWinner ? 'success' : 'warn');
            
            currentGameId = null;
            playerSide = null;
            
            setTimeout(() => {
                opponentUsername = null;
                updateUI();
            }, 3000);
        }
        
        // Game actions
        function joinMatchmaking() {
            sendMessage('pong.joinMatchmaking', {});
            isInMatchmaking = true;
            log('Joining matchmaking...', 'info');
            updateUI();
        }
        
        function leaveMatchmaking() {
            sendMessage('pong.leaveMatchmaking', {});
            isInMatchmaking = false;
            log('Left matchmaking', 'info');
            updateUI();
        }
        
        function createCustomGame() {
            const opponentId = document.getElementById('opponentIdInput').value.trim();
            if (!opponentId) {
                log('Enter opponent ID first', 'error');
                return;
            }
            sendMessage('pong.createCustomGame', { otherId: opponentId });
        }
        
        function joinCustomGame() {
            const gameId = document.getElementById('gameIdInput').value.trim();
            if (!gameId) {
                log('Enter game ID first', 'error');
                return;
            }
            sendMessage('pong.joinCustomGame', { gameId });
        }
        
        function setReady(ready) {
            if (currentGameId) {
                const event = ready ? 'pong.userReady' : 'pong.userNotReady';
                sendMessage(event, { gameId: currentGameId });
                log(ready ? 'Marked as ready' : 'Marked as not ready', 'info');
            }
        }
        
        function quitGame() {
            if (currentGameId) {
                sendMessage('pong.userQuit', { gameId: currentGameId });
                log('Quitting game...', 'info');
                currentGameId = null;
                playerSide = null;
                opponentUsername = null;
                updateUI();
            }
        }
        
        // Event listeners
        document.getElementById('gameModeSelect').addEventListener('change', updateUI);
        document.getElementById('startOfflineBtn').addEventListener('click', startOfflineGame);
        document.getElementById('stopOfflineBtn').addEventListener('click', stopOfflineGame);
        document.getElementById('loginBtn').addEventListener('click', login);
        document.getElementById('logoutBtn').addEventListener('click', logout);
        document.getElementById('joinMatchmakingBtn').addEventListener('click', joinMatchmaking);
        document.getElementById('leaveMatchmakingBtn').addEventListener('click', leaveMatchmaking);
        document.getElementById('createCustomBtn').addEventListener('click', createCustomGame);
        document.getElementById('joinCustomBtn').addEventListener('click', joinCustomGame);
        document.getElementById('readyBtn').addEventListener('click', () => setReady(true));
        document.getElementById('notReadyBtn').addEventListener('click', () => setReady(false));
        document.getElementById('quitBtn').addEventListener('click', quitGame);
        document.getElementById('clearLogBtn').addEventListener('click', clearLog);
        
        // Online movement interval
        let moveInterval = null;
        document.addEventListener('keydown', (e) => {
            if (game.gameManager.mode === GAME_MODES.ONLINE && currentGameId && !moveInterval) {
                let direction = null;
                if (e.key === 'ArrowUp' || e.key === 'w' || e.key === 'W') direction = 'up';
                else if (e.key === 'ArrowDown' || e.key === 's' || e.key === 'S') direction = 'down';
                
                if (direction) {
                    e.preventDefault();
                    sendMessage('pong.paddleMove', { gameId: currentGameId, direction });
                    moveInterval = setInterval(() => {
                        sendMessage('pong.paddleMove', { gameId: currentGameId, direction });
                    }, 50);
                }
            }
        });
        
        document.addEventListener('keyup', (e) => {
            if (['ArrowUp', 'ArrowDown', 'w', 'W', 's', 'S'].includes(e.key)) {
                if (moveInterval) {
                    clearInterval(moveInterval);
                    moveInterval = null;
                }
            }
        });

        // Initialize
        updateUI();
        window.pongGame = game; // Expose to window for direct interaction
        log('Game system initialized from src/main.js', 'success');
    </script>
</body>
</html>
